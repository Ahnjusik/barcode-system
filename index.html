<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ë°”ì½”ë“œ ì‹¤ì‹œê°„ ê³µìœ  ì‹œìŠ¤í…œ (ìµœì¢… ë³´ì •ë³¸)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 600px; }
        #status { margin-top: 20px; font-weight: bold; font-size: 18px; min-height: 30px; padding: 15px; border-radius: 8px; transition: 0.3s; }
        .waiting { background-color: #ecf0f1; color: #7f8c8d; }
        .connected { background-color: #e3f2fd; color: #1976d2; border: 2px solid #2196f3; }
        .success { background-color: #dff9fb; color: #2ecc71; border: 2px solid #2ecc71; }
        .danger { background-color: #fab1a0; color: #e74c3c; border: 2px solid #e74c3c; }
        .button-group { margin: 20px 0; display: flex; gap: 10px; justify-content: center; }
        .btn { border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-connect { background: #3498db; }
        .btn-excel { background: #27ae60; }
        #barcodeList { text-align: left; margin-top: 20px; list-style: none; padding: 0; border-top: 2px solid #eee; }
        #barcodeList li { background: #fff; border-bottom: 1px solid #eee; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #4A90E2; margin-bottom: 8px; border-radius: 0 8px 8px 0; }
        .barcode-text { font-family: 'Courier New', monospace; font-size: 15px; word-break: break-all; margin-right: 10px; flex: 1; }
        .del-btn { background: #ff7675; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸŒ ë¬´ì„  ë°”ì½”ë“œ ê³µìœ  ì‹œìŠ¤í…œ (ë³´ì • ëª¨ë“œ)</h2>
        <div id="status" class="waiting">ìŠ¤ìºë„ˆë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</div>

        <div class="button-group">
            <button id="connectBtn" class="btn btn-connect">ğŸ”Œ ìŠ¤ìºë„ˆ ì¥ì¹˜ ì—°ê²°</button>
            <button class="btn btn-excel" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <ul id="barcodeList"></ul>
    </div>

    <script>
        // --- 1. Firebase ì„¤ì • ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrc5TGuXChUFvTLq0Aw-4CgDvXUfWkBgE",
            authDomain: "barcode-scaner-1d43e.firebaseapp.com",
            databaseURL: "https://barcode-scaner-1d43e-default-rtdb.firebaseio.com",
            projectId: "barcode-scaner-1d43e",
            storageBucket: "barcode-scaner-1d43e.firebasestorage.app",
            messagingSenderId: "357566040009",
            appId: "1:357566040009:web:19c0335d2d144e1fd08a18"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const barcodeRef = db.ref('barcodes');

        const status = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const list = document.getElementById('barcodeList');
        
        let rawData = {};
        let scannedData = [];

        barcodeRef.on('value', (snapshot) => {
            rawData = snapshot.val() || {};
            scannedData = Object.values(rawData);
            renderList();
        });

        // --- 2. ì‹œë¦¬ì–¼ ì—°ê²° ë¡œì§ ---
        connectBtn.addEventListener('click', async () => {
            if (!("serial" in navigator)) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹œë¦¬ì–¼ í†µì‹ ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chromeì„ ì‚¬ìš©í•˜ì„¸ìš”.");
                return;
            }
            try {
                const port = await navigator.serial.requestPort();
                // ë°ì´í„° ìœ ì‹¤ì´ ì¦ë‹¤ë©´ baudRateë¥¼ 115200ìœ¼ë¡œ ë³€ê²½í•´ ë³´ì„¸ìš”
                await port.open({ baudRate: 9600 }); 

                status.innerText = "âœ… ì—°ê²° ì„±ê³µ! ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”.";
                status.className = "connected";
                connectBtn.style.visibility = "hidden";

                readSerialWithBuffer(port);
            } catch (error) {
                status.innerText = "âŒ ì—°ê²° ì˜¤ë¥˜: " + error.message;
                status.className = "danger";
            }
        });

        // --- 3. [í•µì‹¬] ì¡°ê°ë‚œ ë°ì´í„° í•©ì¹˜ê¸° ë¡œì§ ---
        async function readSerialWithBuffer(port) {
            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            
            let buffer = "";
            let timeoutId = null;

            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    if (value) {
                        buffer += value; // ì¡°ê°ë‚œ ë°ì´í„°ë¥¼ ë²„í¼ì— ê³„ì† ì¶”ê°€

                        // ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì·¨ì†Œ (ìƒˆ ë°ì´í„°ê°€ ê³„ì† ë“¤ì–´ì˜¤ëŠ” ì¤‘)
                        if (timeoutId) clearTimeout(timeoutId);

                        // ë§ˆì§€ë§‰ ì¡°ê°ì´ ë“¤ì–´ì˜¨ í›„ 50ms ë™ì•ˆ ì ì í•˜ë©´ ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œë¡œ ê°„ì£¼
                        timeoutId = setTimeout(() => {
                            const finalCode = buffer.replace(/[\r\n]/g, "").trim();
                            if (finalCode.length > 2) { // ë„ˆë¬´ ì§§ì€ ì“°ë ˆê¸° ê°’ ë°©ì§€
                                processBarcode(finalCode);
                            }
                            buffer = ""; // ë‹¤ìŒ ìŠ¤ìº”ì„ ìœ„í•´ ë²„í¼ ì´ˆê¸°í™”
                            timeoutId = null;
                        }, 50); 
                    }
                }
            } catch (error) {
                console.error("ìˆ˜ì‹  ì¤‘ë‹¨:", error);
                status.innerText = "âŒ ì—°ê²° ëŠê¹€";
                status.className = "danger";
                connectBtn.style.visibility = "visible";
            }
        }

        // --- 4. ë°ì´í„° ì €ì¥ ë° ì²˜ë¦¬ ---
        function processBarcode(code) {
            const isDuplicate = scannedData.some(item => item.code === code);

            if (isDuplicate) {
                playWarningSound();
                status.innerText = "âš ï¸ ì¤‘ë³µ ë°ì´í„°: " + code;
                status.className = "danger";
            } else {
                const now = new Date();
                barcodeRef.push({
                    code: code,
                    time: now.toLocaleString('ko-KR')
                });
                status.innerText = "âœ… ë“±ë¡ ì™„ë£Œ: " + code;
                status.className = "success";
            }
            
            setTimeout(() => {
                if (status.className !== "waiting") {
                    status.innerText = "âœ… ìŠ¤ìºë„ˆ ì—°ê²°ë¨ (ìˆ˜ì‹  ëŒ€ê¸° ì¤‘)";
                    status.className = "connected";
                }
            }, 2000);
        }

        function renderList() {
            list.innerHTML = "";
            const keys = Object.keys(rawData).reverse();
            keys.forEach(key => {
                const item = rawData[key];
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="barcode-text">
                        <strong>${item.code}</strong><br>
                        <span style="color:#888; font-size:11px;">${item.time}</span>
                    </div>
                    <button class="del-btn" onclick="deleteBarcode('${key}', '${item.code}')">ì‚­ì œ</button>
                `;
                list.appendChild(li);
            });
        }

        function deleteBarcode(key, code) {
            if (confirm(`'${code}' ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                barcodeRef.child(key).remove();
            }
        }

        function playWarningSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) { }
        }

        function exportToExcel() {
            if (scannedData.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            let csvContent = "\uFEFFë°”ì½”ë“œ ë²ˆí˜¸,ìŠ¤ìº” ì‹œê°„\n";
            scannedData.forEach(item => {
                csvContent += `"${item.code}","${item.time}"\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Barcode_Data_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
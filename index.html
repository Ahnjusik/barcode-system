<!DOCTYPE html>
<html>
<head>
    <title>ë°”ì½”ë“œ ì‹¤ì‹œê°„ ê³µìœ  ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 600px; }
        #inputBox { padding: 12px; font-size: 18px; width: 80%; border: 2px solid #ddd; border-radius: 8px; outline: none; text-transform: uppercase; }
        #status { margin-top: 20px; font-weight: bold; font-size: 18px; min-height: 27px; }
        .success { color: #2ecc71; }
        .danger { color: #e74c3c; animation: shake 0.2s ease-in-out 2; }
        .button-group { margin: 15px 0; display: flex; justify-content: center; gap: 10px; }
        .btn { border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .export-btn { background: #27ae60; }
        #barcodeList { text-align: left; margin-top: 20px; list-style: none; padding: 0; border-top: 2px solid #eee; }
        #barcodeList li { background: #fff; border-bottom: 1px solid #eee; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { background: #ff7675; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸŒ ë°”ì½”ë“œ ì‹¤ì‹œê°„ ê³µìœ  ê²€ì‚¬ê¸°</h2>
        <input type="text" id="inputBox" placeholder="ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”" autofocus>
        <div id="status">ì—°ê²° ì¤‘...</div>
        <div class="button-group">
            <button class="btn export-btn" onclick="exportToExcel()">ğŸ“Š Excelë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <ul id="barcodeList"></ul>
    </div>

    <script>
        // --- [ì¤‘ìš”] ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase ì„¤ì • ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš” ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrc5TGuXChUFvTLq0Aw-4CgDvXUfWkBgE",
  	authDomain: "barcode-scaner-1d43e.firebaseapp.com",
  	databaseURL: "https://barcode-scaner-1d43e-default-rtdb.firebaseio.com",
 	projectId: "barcode-scaner-1d43e",
  	storageBucket: "barcode-scaner-1d43e.firebasestorage.app",
  	messagingSenderId: "357566040009",
  	appId: "1:357566040009:web:19c0335d2d144e1fd08a18"
};
        // -------------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const barcodeRef = db.ref('barcodes');

        let scannedData = [];
        const inputBox = document.getElementById('inputBox');
        const status = document.getElementById('status');
        const list = document.getElementById('barcodeList');

        // DB ì‹¤ì‹œê°„ ê°ì‹œ (ê¸°ê¸° ê°„ ê³µìœ  í•µì‹¬)
        barcodeRef.on('value', (snapshot) => {
            const data = snapshot.val();
            scannedData = data ? Object.values(data) : [];
            status.innerText = "ì„œë²„ ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ê³µìœ  ì¤‘)";
            renderList();
        });

        function playWarningSound() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }

        inputBox.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const code = this.value.trim().toUpperCase();
                if (code === "") return;

                const isDuplicate = scannedData.some(item => item.code === code);

                if (isDuplicate) {
                    playWarningSound();
                    status.innerText = "âŒ ì¤‘ë³µëœ ë°”ì½”ë“œì…ë‹ˆë‹¤: " + code;
                    status.className = "danger";
                } else {
                    const now = new Date();
                    const timestamp = now.toLocaleString();
                    
                    // Firebase DBì— ì €ì¥
                    barcodeRef.push({ code, time: timestamp });

                    status.innerText = "âœ… ë“±ë¡ ì™„ë£Œ: " + code;
                    status.className = "success";
                }
                this.value = "";
            }
        });

        function renderList() {
            list.innerHTML = "";
            [...scannedData].reverse().forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${item.code}</strong> <span style="color:#888; font-size:12px; margin-left:10px;">[${item.time}]</span></div>`;
                list.appendChild(li);
            });
        }

        function exportToExcel() {
            if (scannedData.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            let csvContent = "\uFEFFë°”ì½”ë“œ ë²ˆí˜¸,ìŠ¤ìº” ì‹œê°„\n";
            scannedData.forEach(item => csvContent += `${item.code},${item.time}\n`);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `shared_barcode_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
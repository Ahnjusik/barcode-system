<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ë°”ì½”ë“œ ì‹œë¦¬ì–¼ ì‹¤ì‹œê°„ ê³µìœ  ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 600px; }
        
        #status { margin-top: 20px; font-weight: bold; font-size: 18px; min-height: 30px; padding: 15px; border-radius: 8px; transition: 0.3s; }
        .waiting { background-color: #ecf0f1; color: #7f8c8d; }
        .connected { background-color: #e3f2fd; color: #1976d2; border: 2px solid #2196f3; }
        .success { background-color: #dff9fb; color: #2ecc71; border: 2px solid #2ecc71; }
        .danger { background-color: #fab1a0; color: #e74c3c; border: 2px solid #e74c3c; }
        
        .button-group { margin: 20px 0; display: flex; gap: 10px; justify-content: center; }
        .btn { border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-connect { background: #3498db; }
        .btn-connect:hover { background: #2980b9; }
        .btn-excel { background: #27ae60; }
        
        #barcodeList { text-align: left; margin-top: 20px; list-style: none; padding: 0; border-top: 2px solid #eee; }
        #barcodeList li { background: #fff; border-bottom: 1px solid #eee; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #4A90E2; margin-bottom: 8px; border-radius: 0 8px 8px 0; }
        .barcode-text { font-family: 'Courier New', monospace; font-size: 16px; }
        .del-btn { background: #ff7675; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸŒ ë¬´ì„  ë°”ì½”ë“œ ê³µìœ  ì‹œìŠ¤í…œ (Serial)</h2>
        <p style="font-size: 13px; color: #666;">ì…ë ¥ê¸°(í•œ/ì˜) ê°„ì„­ ì—†ëŠ” ì‹œë¦¬ì–¼ í†µì‹  ëª¨ë“œ</p>
        
        <div id="status" class="waiting">ìŠ¤ìºë„ˆë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”</div>

        <div class="button-group">
            <button id="connectBtn" class="btn btn-connect">ğŸ”Œ ìŠ¤ìºë„ˆ ì¥ì¹˜ ì—°ê²°</button>
            <button class="btn btn-excel" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <ul id="barcodeList"></ul>
    </div>

    <script>
        // 1. Firebase ì„¤ì • (ë³¸ì¸ì˜ ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”)
        const firebaseConfig = {
            apiKey: "AIzaSyCrc5TGuXChUFvTLq0Aw-4CgDvXUfWkBgE",
            authDomain: "barcode-scaner-1d43e.firebaseapp.com",
            databaseURL: "https://barcode-scaner-1d43e-default-rtdb.firebaseio.com",
            projectId: "barcode-scaner-1d43e",
            storageBucket: "barcode-scaner-1d43e.firebasestorage.app",
            messagingSenderId: "357566040009",
            appId: "1:357566040009:web:19c0335d2d144e1fd08a18"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const barcodeRef = db.ref('barcodes');

        const status = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const list = document.getElementById('barcodeList');
        
        let rawData = {};
        let scannedData = [];

        // 2. ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ë° ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        barcodeRef.on('value', (snapshot) => {
            rawData = snapshot.val() || {};
            scannedData = Object.values(rawData);
            renderList();
        });

        // 3. ì‹œë¦¬ì–¼ í†µì‹  ì—°ê²° ë¡œì§
        connectBtn.addEventListener('click', async () => {
            if (!("serial" in navigator)) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹œë¦¬ì–¼ í†µì‹ ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ ë˜ëŠ” ì—£ì§€ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.");
                return;
            }

            try {
                // ì¥ì¹˜ ì„ íƒ íŒì—… ìš”ì²­
                const port = await navigator.serial.requestPort();
                // í¬íŠ¸ ì—´ê¸° (BaudRateëŠ” ìŠ¤ìºë„ˆ ì„¤ì •ì— ë”°ë¼ 9600 ë˜ëŠ” 115200)
                await port.open({ baudRate: 9600 });

                status.innerText = "âœ… ìŠ¤ìºë„ˆ ì—°ê²°ë¨ (ìŠ¤ìº”í•˜ì„¸ìš”)";
                status.className = "connected";
                connectBtn.style.display = "none"; // ì—°ê²° í›„ ë²„íŠ¼ ìˆ¨ê¹€

                // ë°ì´í„° ìŠ¤íŠ¸ë¦¼ ì½ê¸° ì‹œì‘
                readSerialData(port);

            } catch (error) {
                console.error(error);
                status.innerText = "âŒ ì—°ê²° ì‹¤íŒ¨: " + error.message;
                status.className = "danger";
            }
        });

        // 4. ì‹œë¦¬ì–¼ ë°ì´í„° ì½ê¸° í•¨ìˆ˜
        async function readSerialData(port) {
            const decoder = new TextDecoderStream();
            const inputClosed = port.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            let buffer = "";

            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    if (value) {
                        buffer += value;
                        // ì—”í„°(\r ë˜ëŠ” \n)ê°€ ê°ì§€ë˜ë©´ í•œ ì¤„ ì½ê¸° ì™„ë£Œ
                        if (buffer.includes('\r') || buffer.includes('\n')) {
                            const barcode = buffer.trim();
                            if (barcode) {
                                processBarcode(barcode);
                            }
                            buffer = ""; // ë²„í¼ ì´ˆê¸°í™”
                        }
                    }
                }
            } catch (error) {
                status.innerText = "âŒ ë°ì´í„° ì½ê¸° ì˜¤ë¥˜";
                status.className = "danger";
            } finally {
                reader.releaseLock();
            }
        }

        // 5. ë°”ì½”ë“œ ì²˜ë¦¬ (ì¤‘ë³µ ì²´í¬ ë° ì €ì¥)
        function processBarcode(code) {
            const isDuplicate = scannedData.some(item => item.code === code);

            if (isDuplicate) {
                playWarningSound();
                status.innerText = "âš ï¸ ì¤‘ë³µ ë°œìƒ: " + code;
                status.className = "danger";
            } else {
                const now = new Date();
                barcodeRef.push({
                    code: code,
                    time: now.toLocaleString('ko-KR')
                });
                status.innerText = "âœ… ë“±ë¡ ì™„ë£Œ: " + code;
                status.className = "success";
                
                setTimeout(() => {
                    if (status.className === "success") {
                        status.innerText = "âœ… ìŠ¤ìºë„ˆ ì—°ê²°ë¨ (ìŠ¤ìº”í•˜ì„¸ìš”)";
                        status.className = "connected";
                    }
                }, 1500);
            }
        }

        // --- ë³´ì¡° í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼) ---

        function renderList() {
            list.innerHTML = "";
            const keys = Object.keys(rawData).reverse();
            keys.forEach(key => {
                const item = rawData[key];
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="barcode-text">
                        <strong>${item.code}</strong><br>
                        <span style="color:#888; font-size:11px;">${item.time}</span>
                    </div>
                    <button class="del-btn" onclick="deleteBarcode('${key}', '${item.code}')">ì‚­ì œ</button>
                `;
                list.appendChild(li);
            });
        }

        function deleteBarcode(key, code) {
            if (confirm(`'${code}' ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                barcodeRef.child(key).remove();
            }
        }

        function playWarningSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) { }
        }

        function exportToExcel() {
            if (scannedData.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            let csvContent = "\uFEFFë°”ì½”ë“œ ë²ˆí˜¸,ìŠ¤ìº” ì‹œê°„\n";
            scannedData.forEach(item => {
                csvContent += `"${item.code}","${item.time}"\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Barcode_Data_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
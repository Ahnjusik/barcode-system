<!DOCTYPE html>
<html>
<head>
    <title>ë°”ì½”ë“œ ì‹œë¦¬ì–¼ í†µì‹  ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .conn-btn { background: #3498db; margin-bottom: 20px; }
        #status.connected { background-color: #dff9fb; color: #0984e3; border: 2px solid #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ”Œ ì‹œë¦¬ì–¼ ë°”ì½”ë“œ ì‹œìŠ¤í…œ</h2>
        <button id="connectBtn" class="btn conn-btn">ìŠ¤ìºë„ˆ ì—°ê²°í•˜ê¸°</button>
        
        <div id="status" class="waiting">ìŠ¤ìºë„ˆë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.</div>
        
        <div class="button-group">
            <button class="btn" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <ul id="barcodeList"></ul>
    </div>

    <script>
        // Firebase ì„¤ì • (ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        const firebaseConfig = { /* ... ë³¸ì¸ì˜ ì„¤ì •ê°’ ... */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const barcodeRef = db.ref('barcodes');

        const status = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        let scannedData = [];

        // 1. ì‹œë¦¬ì–¼ í†µì‹  í•µì‹¬ ë¡œì§
        connectBtn.addEventListener('click', async () => {
            if (!("serial" in navigator)) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹œë¦¬ì–¼ í†µì‹ ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome/Edge ê¶Œì¥)");
                return;
            }

            try {
                // ì¥ì¹˜ ì„ íƒ íŒì—… ì—´ê¸°
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 }); // ëŒ€ë¶€ë¶„ì˜ ìŠ¤ìºë„ˆ ê¸°ë³¸ê°’ 9600

                status.innerText = "âœ… ìŠ¤ìºë„ˆ ì—°ê²°ë¨ (ë°ì´í„° ìˆ˜ì‹  ëŒ€ê¸° ì¤‘)";
                status.className = "success";
                connectBtn.style.display = "none"; // ì—°ê²° ì„±ê³µ ì‹œ ë²„íŠ¼ ìˆ¨ê¹€

                // ìŠ¤íŠ¸ë¦¼ ì½ê¸° ì„¤ì •
                const decoder = new TextDecoderStream();
                port.readable.pipeTo(decoder.writable);
                const reader = decoder.readable.getReader();

                let buffer = "";

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    if (value) {
                        buffer += value;
                        // ì—”í„°(ì¤„ë°”ê¿ˆ)ê°€ ë“¤ì–´ì˜¤ë©´ ë°ì´í„° í•œ ê±´ìœ¼ë¡œ ì¸ì‹
                        if (buffer.includes('\r') || buffer.includes('\n')) {
                            const cleanCode = buffer.trim();
                            if (cleanCode) processBarcode(cleanCode);
                            buffer = ""; // ë²„í¼ ì´ˆê¸°í™”
                        }
                    }
                }
            } catch (error) {
                console.error(error);
                status.innerText = "âŒ ì—°ê²° ì˜¤ë¥˜: " + error.message;
                status.className = "danger";
            }
        });

        // 2. ë°”ì½”ë“œ ì²˜ë¦¬ ë° ì¤‘ë³µ ì²´í¬ (ê¸°ì¡´ ë¡œì§ í™œìš©)
        function processBarcode(code) {
            // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•´ í˜„ì¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
            barcodeRef.once('value', (snapshot) => {
                const data = snapshot.val() || {};
                const list = Object.values(data);
                const isDuplicate = list.some(item => item.code === code);

                if (isDuplicate) {
                    playWarningSound();
                    status.innerText = "âš ï¸ ì¤‘ë³µ ë°”ì½”ë“œ: " + code;
                    status.className = "danger";
                } else {
                    const now = new Date();
                    barcodeRef.push({ 
                        code: code, 
                        time: now.toLocaleString('ko-KR') 
                    });
                    status.innerText = "âœ… ìŠ¤ìº” ì„±ê³µ: " + code;
                    status.className = "success";
                }
            });
        }

        // ê¸°ì¡´ì˜ renderList, deleteBarcode, exportToExcel í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        // ... (ìƒëµ) ...
    </script>
</body>
</html>
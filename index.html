<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ë°”ì½”ë“œ ì‹œìŠ¤í…œ (ë°ì´í„° ë³µêµ¬/ì—…ë¡œë“œ ê¸°ëŠ¥)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 600px; }
        #status { margin-top: 20px; font-weight: bold; font-size: 18px; min-height: 30px; padding: 15px; border-radius: 8px; transition: 0.3s; }
        .waiting { background-color: #ecf0f1; color: #7f8c8d; }
        .connected { background-color: #e3f2fd; color: #1976d2; border: 2px solid #2196f3; }
        .success { background-color: #dff9fb; color: #2ecc71; border: 2px solid #2ecc71; }
        .danger { background-color: #fab1a0; color: #e74c3c; border: 2px solid #e74c3c; }
        
        .button-group { margin: 20px 0; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .btn { border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 14px; }
        .btn-connect { background: #3498db; }
        .btn-excel { background: #27ae60; }
        .btn-upload { background: #e67e22; } /* ì—…ë¡œë“œ ë²„íŠ¼ ìƒ‰ìƒ */
        
        #barcodeList { text-align: left; margin-top: 20px; list-style: none; padding: 0; border-top: 2px solid #eee; }
        #barcodeList li { background: #fff; border-bottom: 1px solid #eee; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #27ae60; margin-bottom: 8px; border-radius: 0 8px 8px 0; }
        .barcode-text { font-family: 'Courier New', monospace; font-size: 15px; }
        .del-btn { background: #ff7675; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        
        /* íŒŒì¼ ì…ë ¥ì°½ ìˆ¨ê¹€ */
        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸŒ ë°”ì½”ë“œ ê³µìœ  (ë°ì´í„° ë³µêµ¬ ëª¨ë“œ)</h2>
        <div id="status" class="waiting">ìŠ¤ìºë„ˆë¥¼ ì—°ê²°í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
        
        <div class="button-group">
            <button id="connectBtn" class="btn btn-connect">ğŸ”Œ ìŠ¤ìºë„ˆ ì—°ê²°</button>
            <button class="btn btn-excel" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“‚ CSV ë°ì´í„° ì—…ë¡œë“œ</button>
            <input type="file" id="fileInput" accept=".csv" onchange="importFromCSV(event)">
        </div>

        <ul id="barcodeList"></ul>
    </div>

    <script>
        // --- 1. Firebase ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrc5TGuXChUFvTLq0Aw-4CgDvXUfWkBgE",
            authDomain: "barcode-scaner-1d43e.firebaseapp.com",
            databaseURL: "https://barcode-scaner-1d43e-default-rtdb.firebaseio.com",
            projectId: "barcode-scaner-1d43e",
            storageBucket: "barcode-scaner-1d43e.firebasestorage.app",
            messagingSenderId: "357566040009",
            appId: "1:357566040009:web:19c0335d2d144e1fd08a18"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const barcodeRef = db.ref('barcodes');

        const status = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const list = document.getElementById('barcodeList');
        let rawData = {};

        // ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ë™ê¸°í™”
        barcodeRef.on('value', (snapshot) => {
            rawData = snapshot.val() || {};
            renderList();
        });

        // --- 2. ì‹œë¦¬ì–¼ ì—°ê²° ë¡œì§ (ê¸°ì¡´ ìœ ì§€) ---
        connectBtn.addEventListener('click', async () => {
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 }); 
                status.innerText = "âœ… ì—°ê²°ë¨! ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”.";
                status.className = "connected";
                connectBtn.style.visibility = "hidden";
                readSerialWithBuffer(port);
            } catch (error) {
                status.innerText = "âŒ ì—°ê²° ì˜¤ë¥˜: " + error.message;
                status.className = "danger";
            }
        });

        async function readSerialWithBuffer(port) {
            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            let buffer = "";
            let timeoutId = null;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    buffer += value;
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        const finalCode = buffer.replace(/[\r\n]/g, "").trim();
                        if (finalCode.length > 1) processBarcode(finalCode);
                        buffer = "";
                        timeoutId = null;
                    }, 50); 
                }
            }
        }

        // --- 3. ë°ì´í„° ì €ì¥ (ë®ì–´ì“°ê¸° ë¡œì§) ---
        function processBarcode(code, customTime = null) {
            const now = customTime || new Date().toLocaleString('ko-KR');
            const safeKey = code.replace(/[.$#[\]/]/g, "_");

            return db.ref('barcodes/' + safeKey).set({
                code: code,
                time: now
            });
        }

        // --- 4. [ì‹ ê·œ] CSV íŒŒì¼ì—ì„œ ë°ì´í„° ì½ì–´ì™€ Firebaseë¡œ ì—…ë¡œë“œ ---
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const rows = content.split("\n");
                let count = 0;

                // ì²« ì¤„(í—¤ë”) ì œì™¸í•˜ê³  í•œ ì¤„ì”© ì²˜ë¦¬
                rows.forEach((row, index) => {
                    if (index === 0 || row.trim() === "") return;

                    // ë”°ì˜´í‘œ ì œê±° ë° ì½¤ë§ˆë¡œ ë¶„ë¦¬
                    const columns = row.split(",").map(col => col.replace(/"/g, "").trim());
                    const code = columns[0];
                    const time = columns[1];

                    if (code) {
                        processBarcode(code, time);
                        count++;
                    }
                });

                status.innerText = `âœ… ${count}ê°œì˜ ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!`;
                status.className = "success";
                event.target.value = ""; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            };
            reader.readAsText(file, "UTF-8");
        }

        // --- 5. UI ë Œë”ë§ ë° ì‚­ì œ/ì—‘ì…€ í•¨ìˆ˜ ---
        function renderList() {
            list.innerHTML = "";
            const keys = Object.keys(rawData).reverse();
            keys.forEach(key => {
                const item = rawData[key];
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="barcode-text">
                        <strong>${item.code}</strong><br>
                        <span style="color:#888; font-size:11px;">ìµœê·¼ ê¸°ë¡: ${item.time}</span>
                    </div>
                    <button class="del-btn" onclick="deleteBarcode('${key}')">ì‚­ì œ</button>
                `;
                list.appendChild(li);
            });
        }

        function deleteBarcode(key) {
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref('barcodes/' + key).remove();
        }

        function exportToExcel() {
            const data = Object.values(rawData);
            if (data.length === 0) return alert("ë°ì´í„° ì—†ìŒ");
            let csvContent = "\uFEFFë°”ì½”ë“œ ë²ˆí˜¸,ìŠ¤ìº” ì‹œê°„\n";
            data.forEach(item => { csvContent += `"${item.code}","${item.time}"\n`; });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Barcode_Backup.csv`;
            a.click();
        }
    </script>
</body>
</html>
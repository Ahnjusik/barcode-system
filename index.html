<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°”ì½”ë“œ ì‹¤ì‹œê°„ ê³µìœ  ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif; text-align: center; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 600px; }
        #inputBox { padding: 12px; font-size: 18px; width: 80%; border: 2px solid #ddd; border-radius: 8px; outline: none; text-transform: uppercase; margin-bottom: 10px; }
        #inputBox:focus { border-color: #3498db; }
        #status { margin-top: 15px; font-weight: bold; font-size: 16px; min-height: 24px; padding: 5px; border-radius: 5px; }
        .success { color: #2ecc71; background-color: #eafaf1; }
        .danger { color: #e74c3c; background-color: #fdedec; animation: shake 0.2s ease-in-out 2; }
        .button-group { margin: 15px 0; display: flex; justify-content: center; gap: 10px; }
        .btn { border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .export-btn { background: #27ae60; }
        .export-btn:hover { background: #219150; }
        #barcodeList { text-align: left; margin-top: 20px; list-style: none; padding: 0; border-top: 2px solid #eee; }
        #barcodeList li { 
            background: #fff; 
            border-bottom: 1px solid #eee; 
            padding: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            animation: fadeIn 0.3s ease;
        }
        .del-btn { background: #ff7675; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .del-btn:hover { background: #d63031; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸŒ ë°”ì½”ë“œ ì‹¤ì‹œê°„ ê³µìœ  ê²€ì‚¬ê¸°</h2>
        <input type="text" id="inputBox" placeholder="ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”" autofocus>
        <div id="status">ì—°ê²° ì¤‘...</div>
        
        <div class="button-group">
            <button class="btn export-btn" onclick="exportToExcel()">ğŸ“Š Excelë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        
        <ul id="barcodeList"></ul>
    </div>

    <script>
        // --- [ì¤‘ìš”] Firebase ì„¤ì • (ì‚¬ìš©ìë‹˜ì˜ ì •ë³´ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrc5TGuXChUFvTLq0Aw-4CgDvXUfWkBgE",
            authDomain: "barcode-scaner-1d43e.firebaseapp.com",
            databaseURL: "https://barcode-scaner-1d43e-default-rtdb.firebaseio.com",
            projectId: "barcode-scaner-1d43e",
            storageBucket: "barcode-scaner-1d43e.firebasestorage.app",
            messagingSenderId: "357566040009",
            appId: "1:357566040009:web:19c0335d2d144e1fd08a18"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const barcodeRef = db.ref('barcodes');

        let rawData = {}; // Firebase ì›ë³¸ ë°ì´í„°ë¥¼ ë‹´ì„ ê°ì²´
        const inputBox = document.getElementById('inputBox');
        const status = document.getElementById('status');
        const list = document.getElementById('barcodeList');

        // DB ì‹¤ì‹œê°„ ê°ì‹œ: ë°ì´í„°ê°€ ë³€ê²½ë˜ë©´ ìë™ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
        barcodeRef.on('value', (snapshot) => {
            rawData = snapshot.val() || {};
            status.innerText = "ì„œë²„ ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ê³µìœ  ì¤‘)";
            renderList();
        });

        // ì¤‘ë³µ ê²½ê³ ìŒ ë°œìƒê¸°
        function playWarningSound() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
        }

        // ì…ë ¥ì°½ ì—”í„° ì´ë²¤íŠ¸
        inputBox.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const code = this.value.trim().toUpperCase();
                if (code === "") return;

                // ì¤‘ë³µ ì²´í¬ (rawData ê°ì²´ì˜ ê°’ë“¤ ì¤‘ codeê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸)
                const items = Object.values(rawData);
                const isDuplicate = items.some(item => item.code === code);

                if (isDuplicate) {
                    playWarningSound();
                    status.innerText = "âŒ ì¤‘ë³µëœ ë°”ì½”ë“œì…ë‹ˆë‹¤: " + code;
                    status.className = "danger";
                } else {
                    const now = new Date();
                    const timestamp = now.toLocaleString();
                    
                    // Firebase DBì— ì¶”ê°€ (ìë™ìœ¼ë¡œ ê³ ìœ  Key ìƒì„±ë¨)
                    barcodeRef.push({ code, time: timestamp });

                    status.innerText = "âœ… ë“±ë¡ ì™„ë£Œ: " + code;
                    status.className = "success";
                }
                this.value = "";
            }
        });

        // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì‚­ì œ ë²„íŠ¼ í¬í•¨)
        function renderList() {
            list.innerHTML = "";
            
            // ìµœì‹ ìˆœ ì •ë ¬ì„ ìœ„í•´ Keyë“¤ì„ ê°€ì ¸ì™€ ì—­ìˆœìœ¼ë¡œ ì •ë ¬
            const keys = Object.keys(rawData).reverse();
            
            keys.forEach(key => {
                const item = rawData[key];
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <strong>${item.code}</strong> 
                        <span style="color:#888; font-size:12px; margin-left:10px;">[${item.time}]</span>
                    </div>
                    <button class="del-btn" onclick="deleteItem('${key}')">ì‚­ì œ</button>
                `;
                list.appendChild(li);
            });
        }

        // ê°œë³„ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
        function deleteItem(key) {
            if (confirm("ì •ë§ë¡œ ì´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                // Firebaseì—ì„œ í•´ë‹¹ Keyë¥¼ ì°¾ì•„ ì‚­ì œ
                db.ref('barcodes/' + key).remove()
                    .then(() => {
                        status.innerText = "ğŸ—‘ï¸ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                        status.className = "";
                    })
                    .catch((err) => {
                        alert("ì‚­ì œ ì˜¤ë¥˜: " + err.message);
                    });
            }
        }

        // CSV ë‚´ë³´ë‚´ê¸° (Excel í˜¸í™˜)
        function exportToExcel() {
            const items = Object.values(rawData);
            if (items.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            
            let csvContent = "\uFEFFë°”ì½”ë“œ ë²ˆí˜¸,ìŠ¤ìº” ì‹œê°„\n";
            items.forEach(item => csvContent += `${item.code},${item.time}\n`);
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `shared_barcode_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>